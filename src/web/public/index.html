<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

        <title>CSC - Custom Spelling Corrector</title>

        <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">

        <link rel="stylesheet" type="text/css" href="assets/css/libs.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <link rel="stylesheet" type="text/css" href="assets/css/main.css">
    </head>

    <body class="grey lighten-4">
        <header class="navbar-fixed">
            <nav class="cyan lighten-3">
                <div class="nav-wrapper">
                    <img src="assets/img/logo.png" class="brand-logo center" width="63px">
                    <a href="#" data-activates="mobile-demo" class="button-collapse"><i class="material-icons">menu</i></a>

                    <ul id="nav-mobile" class="right hide-on-med-and-down">
                        <li><a href="#">About</a></li>
                    </ul>

                    <ul class="side-nav" id="mobile-demo">
                        <li><a href="#">About</a></li>
                    </ul>
                </div>
            </nav>
        </header>

        <main class="container">
            <div class="row">
                <div class="col s12 offset-m1 m10 offset-l2 l8">
                    <div class="row">
                        <form id="form-corrector" class="col s12" action="http://localhost:3000/correct" method="post">
                            <div class="row">
                                <div class="input-field col s12">
                                    <i class="material-icons prefix">comment</i>
                                    <input id="sentence" class="validate" type="text" name="sentence" value="">
                                    <label for="sentence">Sentence</label>
                                </div>

                                <div class="col s12 center-align">
                                    <button id="btn-submit" class="btn waves-effect waves-light purple lighten-1" type="submit" name="action">
                                        Try Correct
                                        <i class="material-icons right">send</i>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div id="corrector-progress" class="row hide">
                        <div class="col s12">
                            <div class="progress">
                                <div class="indeterminate"></div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div id="correction-result" class="col s12 hide bold italic">
                            <i class="material-icons left">info_outline</i>
                            <strong>
                                <em>Did you mean:</em>
                            </strong>

                            <blockquote>
                                <ul id="result-list" class="collection orange-text darken-4"></ul>
                            </blockquote>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="page-footer cyan darken-2">
            <div class="footer-copyright">
                <div class="container">
                    &copy; 2016 Rudolf. All Rights Reserved.
                </div>
            </div>
        </footer>

        <script src="assets/js/libs.js" type="text/javascript" charset="utf-8"></script>

        <script type="text/javascript">
            $(document).ready(function () {
                // Initialize button side nav on mobile / smaller device.
                $(".button-collapse").sideNav();

                // Submit form using ajax.
                $('#btn-submit').click(function (e) {
                    e.preventDefault();

                    if ($('#sentence').val() == '') {
                        Materialize.toast('Sentence is empty, rejected', 4000, 'rounded');
                        return;
                    }

                    // Show progress bar after submitting form & disable button.
                    $('#btn-submit').attr('disabled', true);
                    $('#btn-submit').addClass('disabled');
                    $('#corrector-progress').removeClass('hide');

                    $.ajax({
                        type: $('#form-corrector').attr('method'),
                        url: $('#form-corrector').attr('action'),
                        data: $('#form-corrector').serialize(),
                        success: function (response) {
                            $('#correction-result').removeClass('hide');
                            var resultListContainer = $('#result-list');

                            // Clean result before adding new ones.
                            resultListContainer.empty();

                            var corrections = $.map(response.corrections, function (probability, sentence) {
                                return [{
                                    sentence: sentence,
                                    probability: probability
                                }];
                            });

                            // Sort customly.
                            corrections.sort(function (a, b) {
                                // Sort probability descendingly.
                                if (a.probability > b.probability) {
                                    return -1;
                                } else if (a.probability < b.probability) {
                                    return 1;
                                } else {
                                    // Sort sentence ascendingly.
                                    if (a.sentence < b.sentence) {
                                        return -1;
                                    } else if (a.sentence > b.sentence) {
                                        return 1;
                                    } else {
                                        return 0;
                                    }
                                }
                            });

                            corrections.forEach(function (correction) {
                                var childNode = `
                                    <div class="tooltipped" data-position="bottom" data-delay="50" data-tooltip="Probability: ${correction.probability}">
                                        <span class="correction-item">${correction.sentence}</span>
                                    </div>`;
                                resultListContainer.append(`<li class="collection-item">${childNode}</li>`);
                            });

                            // Initialize tooltip.
                            $('.tooltipped').tooltip({delay: 50});
                            $('.correction-item').click(function () {
                                $('#sentence').val($(this).text());
                            });
                        },
                        complete: function () {
                            // Hide progress bar & enable button submit on request completion.
                            $('#btn-submit').removeAttr('disabled');
                            $('#btn-submit').removeClass('disabled');
                            $('#corrector-progress').addClass('hide');
                        }
                    });

                    // Show toast on submit.
                    Materialize.toast('Sentence checked', 2000, 'rounded');
                });

                // Listen for input change, hide correction result if current input
                // is empty.
                $('#sentence').on('input', function () {
                    var content = $(this).val();

                    if (content.length == 0) {
                        $('#correction-result').addClass('hide');
                    }
                });
            });
        </script>
    </body>
</html>
